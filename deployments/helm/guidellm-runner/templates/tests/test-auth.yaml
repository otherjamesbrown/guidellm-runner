apiVersion: v1
kind: Pod
metadata:
  name: {{ include "guidellm-runner.fullname" . }}-test-auth
  labels:
    {{- include "guidellm-runner.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: auth-test
      image: curlimages/curl:8.5.0
      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing authentication to API endpoint..."

          # Get the API URL from the first target in the development environment
          {{- $apiUrl := "" }}
          {{- if .Values.config.environments.development }}
          {{- range .Values.config.environments.development.targets }}
          {{- if not $apiUrl }}
          {{- $apiUrl = .url }}
          {{- end }}
          {{- end }}
          {{- end }}

          {{- if not $apiUrl }}
          echo "ERROR: No API URL found in config.environments.development.targets"
          exit 1
          {{- else }}

          # Test 1: Verify API key is set
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "ERROR: OPENAI_API_KEY environment variable is not set"
            exit 1
          fi
          echo "✓ OPENAI_API_KEY environment variable is set"

          # Test 2: Test authentication with the API
          API_URL="{{ $apiUrl }}"
          echo "Testing authentication to: $API_URL/v1/models"

          HTTP_CODE=$(curl -sf \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -w "%{http_code}" \
            -o /tmp/response.json \
            "$API_URL/v1/models" || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "✓ Authentication successful (HTTP $HTTP_CODE)"
            echo "Response preview:"
            cat /tmp/response.json | head -c 500
            echo ""
          elif [ "$HTTP_CODE" = "401" ]; then
            echo "ERROR: Authentication failed (HTTP 401 Unauthorized)"
            echo "This indicates the API key is invalid or not properly configured"
            cat /tmp/response.json 2>/dev/null || true
            exit 1
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "ERROR: Failed to connect to API endpoint"
            echo "URL: $API_URL/v1/models"
            exit 1
          else
            echo "ERROR: Unexpected HTTP response code: $HTTP_CODE"
            cat /tmp/response.json 2>/dev/null || true
            exit 1
          fi

          echo ""
          echo "========================================="
          echo "✓ All authentication tests passed!"
          echo "========================================="
          {{- end }}
      env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              {{- if .Values.apiKey.existingSecret }}
              name: {{ .Values.apiKey.existingSecret }}
              {{- else }}
              name: {{ include "guidellm-runner.fullname" . }}-api-key
              {{- end }}
              key: {{ .Values.apiKey.existingSecretKey }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 100
        readOnlyRootFilesystem: false
        allowPrivilegeEscalation: false
